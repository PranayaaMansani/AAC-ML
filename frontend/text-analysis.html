<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Metrics - Text Emotion Analysis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D121F; /* Dark background from code 1 */
            color: #e2e8f0; /* Light text color */
        }
        /* Custom scrollbar for text area */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #141A2E; /* Darker track from code 1 */
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #4a5568; /* Lighter thumb */
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the active tab */
        .tab-button.active {
            background-color: #1E2540; /* Darker background from code 1 for active tab */
            color: #ffffff; /* White text for active tab */
            font-weight: 600;
        }
        /* Hide content of inactive tabs */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Hide the default file input button */
        #fileInput {
            display: none;
        }
         /* Active navigation item styling from Code 1 */
         .nav-item a.active {
            background-color: #1E2540;
        }
        .nav-item a.active .text-gray-400 {
            color: #5eead4; /* text-emerald-400 */
        }
        .nav-item a.active .text-gray-300 {
            color: #ffffff; /* text-white */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#0D121F]">

    <!-- Sidebar (Dashboard) -->
    <aside class="w-64 bg-[#141A2E] text-gray-200 flex flex-col p-4 shadow-lg overflow-y-auto">
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-emerald-400">Mood Metrics</h1>
            <p class="text-sm text-gray-400">Emotion Intelligence</p>
        </div>

        <!-- Main Navigation -->
        <nav class="flex-grow">
            <h2 class="text-xs uppercase text-gray-500 font-semibold mb-2">Main Navigation</h2>
            <ul>
                <li class="nav-item mb-1">
                    <a href="dashboard.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="text-analysis.html" class="flex items-center p-2 rounded-md active transition-colors">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300 font-medium">Text Analysis</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="speech-analysis.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="mic" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Speech Analysis</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="video-analysis.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="video" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Video Analysis</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="ai-chatbot.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="message-square" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">AI Chatbot</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="analytics.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Analytics</span>
                    </a>
                </li>
            </ul>

            <h2 class="text-xs uppercase text-gray-500 font-semibold mt-6 mb-2">Account</h2>
            <ul>
                <li class="nav-item mb-1">
                    <a href="settings.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="settings" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Settings</span>
                    </a>
                </li>
                <li class="nav-item mb-1">
                    <a href="profile.html" class="flex items-center p-2 rounded-md hover:bg-[#1E2540] transition-colors">
                        <i data-lucide="user" class="w-5 h-5 mr-2 text-gray-400"></i>
                        <span class="text-gray-300">Profile</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Sign Out -->
        <div class="mt-8">
            <a href="signout.html" class="flex items-center p-2 rounded-md hover:bg-gray-700 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5 mr-2 text-gray-400"></i>
                <span class="text-gray-300">Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 p-8 overflow-y-auto bg-[#0D121F]">
        <!-- Main header for the page -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-100">Text Emotion Analysis</h1>
                <p class="text-gray-400">Analyze emotions and sentiment in text content with AI precision</p>
            </div>
            <div class="flex space-x-4">
                <!-- File upload input and label for the button -->
                <input type="file" id="fileInput" accept=".txt">
                <label for="fileInput" class="flex items-center px-4 py-2 bg-gray-700 text-gray-300 rounded-lg shadow-md hover:bg-gray-600 transition-colors cursor-pointer">
                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                    Upload File
                </label>
                <button
                    id="exportButton"
                    class="flex items-center px-4 py-2 bg-emerald-400 text-slate-900 rounded-lg shadow-md hover:bg-emerald-500 transition-colors"
                >
                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                    Export Results
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left Panel: Text Input -->
            <div class="md:col-span-2 bg-[#141A2E] p-6 rounded-lg shadow-xl">
                <label for="emotionText" class="block text-gray-300 text-sm font-medium mb-2">
                    Text Input
                </label>
                <p class="text-gray-500 text-xs mb-4">Enter or paste the text you want to analyze for emotional content</p>
                <textarea
                    id="emotionText"
                    class="w-full h-48 p-4 bg-gray-700 rounded-md border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-400 resize-none"
                    placeholder="Type or paste your text here..."
                    oninput="updateCharCount()"
                ></textarea>
                <div class="flex justify-between items-center mt-2 text-gray-400 text-sm">
                    <span id="charCount">0 characters</span>
                    <button
                        id="analyzeButton"
                        class="bg-emerald-400 hover:bg-emerald-500 text-slate-900 font-semibold py-2 px-6 rounded-full shadow-md transition-colors duration-200"
                    >
                        Analyze Emotions
                    </button>
                </div>
            </div>

            <!-- Right Panel: Emotion Results -->
            <div class="md:col-span-1 bg-[#141A2E] p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold text-gray-200 mb-1">Emotion Analysis Results</h2>
                <p class="text-gray-400 text-xs mb-4">AI-detected emotions and confidence scores</p>
                <div id="emotionResults">
                    <div class="text-gray-400 text-center py-8">Enter text and click 'Analyze Emotions' to see results.</div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div class="bg-[#141A2E] p-6 rounded-lg shadow-xl mt-6">
            <h2 class="text-xl font-semibold text-gray-200 mb-4">Detailed Analysis</h2>
            <div class="flex border-b border-gray-700 mb-4">
                <button id="overviewTab" class="tab-button px-4 py-2 text-gray-400 hover:text-emerald-400 active" onclick="showTab('overview')">Overview</button>
                <button id="sentenceBreakdownTab" class="tab-button px-4 py-2 text-gray-400 hover:text-emerald-400" onclick="showTab('sentenceBreakdown')">Sentence Breakdown</button>
                <button id="keyPhrasesTab" class="tab-button px-4 py-2 text-gray-400 hover:text-emerald-400" onclick="showTab('keyPhrases')">Key Phrases</button>
            </div>

            <div id="overviewContent" class="tab-content active grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 text-2xl font-bold" id="overallSentiment">N/A</p>
                    <p class="text-gray-400 text-sm">Overall Sentiment</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 text-2xl font-bold" id="confidenceScore">N/A</p>
                    <p class="text-gray-400 text-sm">Confidence Score</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 text-2xl font-bold" id="emotionComplexity">N/A</p>
                    <p class="text-gray-400 text-sm">Emotion Complexity</p>
                </div>
            </div>

            <div id="sentenceBreakdownContent" class="tab-content">
                <p class="text-gray-300 mb-2">Sentence-by-sentence emotion breakdown:</p>
                <ul id="sentenceBreakdownList" class="list-disc list-inside mt-4 text-gray-300">
                    <p class="text-gray-400">Enter text to see a breakdown.</p>
                </ul>
            </div>

            <div id="keyPhrasesContent" class="tab-content">
                <p class="text-gray-300 mb-2">Key phrases and their associated emotions:</p>
                <ul id="keyPhrasesList" class="list-disc list-inside mt-4 text-gray-300">
                    <p class="text-gray-400">Enter text to see key phrases.</p>
                </ul>
            </div>
        </div>
    </main>

    <script>
        const emotionColors = {
            'joy': 'bg-emerald-400',
            'confidence': 'bg-teal-400',
            'neutral': 'bg-gray-400',
            'concern': 'bg-orange-400',
            'sadness': 'bg-purple-400'
        };

        const emotionIcons = {
            'joy': 'smile',
            'confidence': 'award',
            'neutral': 'meh',
            'concern': 'alert-triangle',
            'sadness': 'frown'
        };

        const sentimentColors = {
            'positive': 'text-emerald-400',
            'negative': 'text-red-400',
            'neutral': 'text-gray-400',
            'mixed': 'text-orange-400'
        };

        const emotionTextarea = document.getElementById('emotionText');
        const charCountSpan = document.getElementById('charCount');
        const analyzeButton = document.getElementById('analyzeButton');
        const emotionResultsDiv = document.getElementById('emotionResults');
        const overviewTab = document.getElementById('overviewTab');
        const sentenceBreakdownTab = document.getElementById('sentenceBreakdownTab');
        const keyPhrasesTab = document.getElementById('keyPhrasesTab');
        const overviewContent = document.getElementById('overviewContent');
        const sentenceBreakdownContent = document.getElementById('sentenceBreakdownContent');
        const keyPhrasesContent = document.getElementById('keyPhrasesContent');
        const overallSentiment = document.getElementById('overallSentiment');
        const confidenceScore = document.getElementById('confidenceScore');
        const emotionComplexity = document.getElementById('emotionComplexity');
        const sentenceBreakdownList = document.getElementById('sentenceBreakdownList');
        const keyPhrasesList = document.getElementById('keyPhrasesList');
        const fileInput = document.getElementById('fileInput');

        window.onload = function() {
            // Use a polling function to ensure the Lucide library is loaded before calling createIcons
            function initializeLucideIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                } else {
                    // If the library is not yet loaded, wait and try again.
                    // This handles potential network latency issues with the CDN.
                    setTimeout(initializeLucideIcons, 100);
                }
            }
            initializeLucideIcons();

            updateCharCount();
            showTab('overview');
        };

        function updateCharCount() {
            if (emotionTextarea && charCountSpan) {
                const text = emotionTextarea.value;
                charCountSpan.textContent = `${text.length} characters`;
            }
        }

        async function analyzeTextEmotion() {
            if (!emotionTextarea || !analyzeButton || !emotionResultsDiv) return;

            const text = emotionTextarea.value.trim();
            if (text.length === 0) {
                emotionResultsDiv.innerHTML = '<div class="text-red-400 text-center py-8">Please enter some text to analyze.</div>';
                return;
            }

            analyzeButton.textContent = 'Analyzing...';
            analyzeButton.disabled = true;
            analyzeButton.classList.add('opacity-50', 'cursor-not-allowed');
            emotionResultsDiv.innerHTML = '<div class="text-gray-400 text-center py-8">Analyzing...</div>';

            try {
                const apiUrl = 'http://localhost:5000/analyze-emotion';
                console.log(`Attempting to fetch from: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                console.log("Received response data:", JSON.stringify(responseData, null, 2));
                displayResults(responseData);

            } catch (error) {
                console.error('Error analyzing emotion:', error);
                let errorMessage = 'Error analyzing text. ';
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    errorMessage += 'This usually means the backend server is not running or is inaccessible. Please ensure your Python backend is running and that the `apiUrl` in the JavaScript matches its address and port. Also, check for any CORS errors in your browser\'s console.';
                } else {
                    errorMessage += `Details: ${error.message}`;
                }
                emotionResultsDiv.innerHTML = `<div class="text-red-400 text-center py-8">${errorMessage}</div>`;
                if (overallSentiment) overallSentiment.textContent = 'Error';
                if (confidenceScore) confidenceScore.textContent = 'N/A';
                if (emotionComplexity) emotionComplexity.textContent = 'N/A';
            } finally {
                analyzeButton.textContent = 'Analyze Emotions';
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function displayResults(data) {
            const { overall_emotions, detailed_analysis } = data;
            
            // --- Update Emotion Scores Section ---
            emotionResultsDiv.innerHTML = '';
            const emotionOrder = ['joy', 'confidence', 'neutral', 'concern', 'sadness'];
            emotionOrder.forEach(emotion => {
                const percentage = overall_emotions[emotion] || 0;
                const barColor = emotionColors[emotion] || 'bg-gray-500';
                const iconName = emotionIcons[emotion] || 'info';

                const emotionItem = document.createElement('div');
                emotionItem.className = 'mb-4';
                emotionItem.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-gray-300 flex items-center">
                            <i data-lucide="${iconName}" class="w-4 h-4 mr-2 text-gray-400"></i>
                            ${emotion.charAt(0).toUpperCase() + emotion.slice(1)}
                        </span>
                        <span class="text-gray-300">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="${barColor} h-2.5 rounded-full transition-all duration-500 ease-out" style="width: ${percentage}%"></div>
                    </div>
                `;
                emotionResultsDiv.appendChild(emotionItem);
            });
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // --- Update Detailed Analysis Section (Overview) ---
            if (overallSentiment && detailed_analysis) {
                overallSentiment.textContent = detailed_analysis.overall_sentiment;
                const sentimentClass = sentimentColors[detailed_analysis.overall_sentiment.toLowerCase()] || 'text-gray-400';
                overallSentiment.className = `${sentimentClass} text-2xl font-bold`;
            }
            if (confidenceScore && detailed_analysis) {
                confidenceScore.textContent = `${detailed_analysis.confidence_score}/10`;
            }
            if (emotionComplexity && detailed_analysis) {
                emotionComplexity.textContent = detailed_analysis.emotion_complexity;
            }

            // --- Update Sentence Breakdown ---
            if (sentenceBreakdownList) {
                sentenceBreakdownList.innerHTML = '';
                if (detailed_analysis.sentence_breakdown && detailed_analysis.sentence_breakdown.length > 0) {
                    detailed_analysis.sentence_breakdown.forEach(item => {
                        const li = document.createElement('li');
                        const emotionName = item.emotion ? item.emotion.charAt(0).toUpperCase() + item.emotion.slice(1) : 'Unknown';
                        const percentage = item.percentage !== undefined ? `(${item.percentage}%)` : '';
                        li.textContent = `"${item.sentence}" - ${emotionName} ${percentage}`;
                        sentenceBreakdownList.appendChild(li);
                    });
                } else {
                    sentenceBreakdownList.innerHTML = '<p class="text-gray-400">No sentences found for breakdown.</p>';
                }
            }

            // --- Update Key Phrases ---
            if (keyPhrasesList) {
                keyPhrasesList.innerHTML = '';
                if (detailed_analysis.key_phrases && detailed_analysis.key_phrases.length > 0) {
                    detailed_analysis.key_phrases.forEach(phrase => {
                        const li = document.createElement('li');
                        const emotionName = phrase.emotion ? phrase.emotion.charAt(0).toUpperCase() + phrase.emotion.slice(1) : 'Unknown';
                        li.textContent = `"${phrase.text}" - ${emotionName}`;
                        keyPhrasesList.appendChild(li);
                    });
                } else {
                    keyPhrasesList.innerHTML = '<p class="text-gray-400">No key phrases found.</p>';
                }
            }
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabButton = document.getElementById(tabId + 'Tab');
            const tabContent = document.getElementById(tabId + 'Content');
            if (tabButton) tabButton.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
        }

        // Event listener for the main analyze button
        if (analyzeButton) {
            analyzeButton.addEventListener('click', analyzeTextEmotion);
        }

        // New event listener for file input
        if (fileInput) {
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Populate the textarea with file content
                        emotionTextarea.value = e.target.result;
                        updateCharCount();
                        // Automatically trigger analysis
                        analyzeTextEmotion();
                    };
                    reader.readAsText(file);
                }
                // Clear the file input value to allow the same file to be re-uploaded
                event.target.value = '';
            });
        }
    </script>
</body>
</html>
